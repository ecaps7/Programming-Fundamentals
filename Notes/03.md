# 变量生存期和标识符作用域

## 变量

- 局部变量：在复合语句中定义的变量，它们只能在定义它们的复合语句（包括内层的复合语句）中使用
- 全局变量：是指在函数外部定义的变量，它们一般能被程序中的所有函数使用
```cpp
int x = 0;// 全局变量
void f() 
{ 
    int y=0;// 局部变量 
    x++; 
    y++; 
    a++;// Error, a 无定义
}
int main() 
{ 
    int a=0; // 局部变量 
    f(); 
    a++; 
    x++; 
    y++;// Error, y 无定义
    while (x<10) 
    { 
        int b=0; // 局部变量 
        a++; 
        b++; 
        x++; 
    } 
    b++;// Error, b 无定义
    return 0; 
}
```

## 变量的生存期

- 3 种存储分配方式
    - 静态：从程序开始执行时就进行内存空间分配，直到程序结束才收回它们的空间；全局变量具有静态生存期
    - 自动：在程序执行到定义它们的复合语句（包括函数体）时才分配内存空间，当定义它们的复合语句执行结束时，它们的空间将被收回。局部变量和函数的参数一般具有自动生存期
    - 动态：内存空间在程序中显式地用`new`操作分配、用`delete`操作收回。动态变量具有动态生存期
- 存储类标识符
    - `auto`：自动生存期，局部变量默认具有自动生存期
    - `static`：静态生存期，它只在函数第一次调用时进行初始化，以后调用中不再进行初始化，它的值为上一次函数调用结束时的值
    - `register`：局部变量仍是自动生存期，但由编译程序根据CPU寄存器的使用情况来决定是否存放在寄存器中（未必放于内存）

    > 从 C++17 开始，`register` 关键字已被弃用。
```cpp
void f() 
{ 
    auto int x=0; //auto一般不写 
    static int y=1; 
    register int z=0; 
    x++; 
    y++; 
    z++; 
    cout << x << y << z << endl; 
} 
// 在main函数中调用f();
//第一次调用f时，输出：1 2 1
//第二次调用f时，输出：1 3 1
```

## 程序实体在内存中的安排

- 分区
    - 静态数据区：用于全局变量、`static`存储类的局部变量以及常量的内存分配
    - 代码区：用于存放程序的指令，在C++程序中，代码区存放的是所有二进制代码
    - 栈区：用于`auto`存储类的局部变量、函数的形式参数以及函数调用时有关信息的内存分配
    - 堆区：用于**动态变量**的内存分配
    - 文字常量区：存放常量字符串， 程序结束后由系统释放
- 关于栈区和堆区
    - 栈区：由编译器自动分配释放，存放函数的参数值，局部变量的值等，内存的分配是**连续**的
    - 堆区：一般由程序员分配释放，在内存中的分布**不是连续的**

## 标识符的作用域

- 生存期与作用域
    - 生存期：**时间**上的概念，只变量占有内存空间的时间段
    - 作用域：**空间**的概念，指标识符的有效范围
- 作用域
    - 局部作用域：局部常量名、局部变量名、对象名、函数形参名具有局部作用域
    - 全局作用域：函数级定义的标识符、全局变量名或对象名、全局函数名、全局类名一般具有全局作用域
    - 文件作用域：在全局标识符的定义中加入`static`修饰符，它们只能在源文件中使用
    - 函数作用域
    - 名空间作用域

## C++的多模块结构

一个C++模块一般包含两个部分。
- 接口(`.h` 文件)：给出在本模块中定义的、提供给其它模块使用的一些程序实体
- 实现(`.cpp` 文件)：给出模块中程序实体的定义
```h
// 1.h
extern int x;
extern double y;
int func();
```

```cpp
#include <1.h>
int main()
{
    double r;
    r = x + y * func();
    return 0;
}
```